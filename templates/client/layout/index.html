{% load i18n static %}

{# !!! Don't import in any other pages again !!! #}
{% include 'client/layout/components/header/index.html' %}
{% include 'client/layout/components/sidebar/index.html' %}
{% include 'client/layout/components/footer/index.html' %}
{% include 'client/components/iframe/index.html' %}

<script type="text/x-template" id="suit-layout">
  <a-layout>
    <suit-header></suit-header>
    <a-layout style="height: calc(100vh - 64px)">
      <suit-sidebar></suit-sidebar>
      <a-layout>
        <a-layout-content>
          <div class="card-container" id="content-wrapper">
            <a-tabs hide-add type="editable-card" :tab-bar-gutter=1 v-model="activeKey" @edit="onEdit">
              <a-tab-pane key="0" closable>
                <span slot="tab">{% trans 'Dashboard' %}</span>
                <suit-iframe :href="`{% url 'dashboard' %}`" :height="height"></suit-iframe>
              </a-tab-pane>
              <a-tab-pane v-for="(pane, index) in activePanes" :key="pane.key">
                <span slot="tab"><% pane.title %></span>
                <suit-iframe :href="pane.key" :height="height"></suit-iframe>
              </a-tab-pane>
            </a-tabs>
          </div>
        </a-layout-content>
        <suit-footer :app="app" :auth="auth"></suit-footer>
      </a-layout>
    </a-layout>
  </a-layout>
</script>

<script type="application/javascript">
  Vue.component('suit-layout', {
    delimiters: ['<%', '%>'],
    template: '#suit-layout',
    data: function () {
      return {
        app: {},
        auth: {},
        height: `${window.innerHeight - 240}px`,
        csrftoken: Cookies.get('csrftoken')
      }
    },
    computed: {
      activeKey: {
        get: function () {
          return this.$store.state.app.activeKey;
        },
        set: function (value) {
          this.$store.commit('app/changeActiveKey', value);
        }
      },
      activePanes: {
        get: function () {
          return this.$store.state.app.activePanes;
        }
      },
      ...Vuex.mapGetters('app', {
        collapsed: 'collapsed'
      })
    },
    created: function () {
      const _this = this;
      Bus.$on('menuSelected', function(payload){
        _this.add(payload);
      });
      this.getApplication();
    },
    methods: {
      getApplication () {
        axios({
          url: "{% url 'settings:application' %}",
          method: "GET",
          headers: {
            'X-CSRFTOKEN': this.csrftoken
          }
        }).then(response => {
          const {code, data} = response.data;
          if (code === "00000000") {
            const {app, auth} = data;
            this.app = app;
            this.auth = auth;
          }
        }).catch(error => {
          console.log(error);
        });
      },
      onEdit (key, action) {
        this[action](key)
      },
      add (payload) {
        this.$store.commit('app/changeActiveKey', `${payload.key}`);
        if (this.activePanes.indexOf(payload) === -1) {
          this.$store.commit('app/addActivePanes', payload);
        }
      },
      remove (key) {
        let nextActiveKey = '0';
        this.$store.commit('app/delActivePanes', key);
        if (this.activePanes.length > 0) nextActiveKey = this.activePanes[this.activePanes.length - 1].key;
        this.$store.commit('app/changeActiveKey', nextActiveKey);
      },
    },
  })
</script>